{% extends 'base.html' %}
{% load i18n moderation_tags %}

{% block content %}
<div class="container-narrow">
    <nav class="mb-4">
        <a href="{% url 'forum_subjects' %}" class="text-muted">{% trans "Forums" %}</a> /
        <a href="{% url 'forum_thread_list' subject=thread.subject %}" class="text-muted">{{ thread.get_subject_display }}</a> /
        <span>{{ thread.title }}</span>
    </nav>

    <div class="flex" style="justify-content: space-between; align-items: flex-start;">
        <div>
            <div class="flex mb-2" style="gap: 0.5rem;">
                {% if thread.year %}<span class="badge badge-year">{% trans "Year" %} {{ thread.year }}</span>{% endif %}
                {% if thread.stream %}<span class="badge badge-stream">{{ thread.get_stream_display }}</span>{% endif %}
                <span class="badge badge-secondary">{{ thread.get_category_display }}</span>
            </div>
            <div style="display: flex; gap: 1rem; align-items: flex-start;">
                <h1 class="mb-5" style="flex: 1;">{{ thread.title }}</h1>
                {% if user.is_authenticated and user != thread.author %}
                <button onclick="openReportModal('{{ thread.id }}', '{% get_content_type_id thread %}')"
                    style="background:none; border:none; padding:0; cursor:pointer; color: var(--text-muted); margin-top: 0.5rem; display: flex; align-items: center; justify-content: center;"
                    title="{% trans 'Report Thread' %}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                        <line x1="4" x2="4" y1="22" y2="15"></line>
                    </svg>
                </button>
                {% endif %}
            </div>
        </div>
        {% if user.is_staff or user == thread.author %}
        {% trans "Delete this entire discussion?" as del_msg %} <a href="{% url 'forum_thread_delete' pk=thread.pk %}"
            class="btn btn-secondary btn-sm" style="color: var(--danger); border-color: var(--danger);"
            onclick="return confirm('{{ del_msg|escapejs }}');">{% trans "Delete Thread" %}</a>
        {% endif %}
    </div>

    <div class="flex flex-column" style="gap: 1.5rem;">
        {% for post in posts %}
        <div class="card" style="padding: 1.5rem;">
            <div class="flex mb-3"
                style="justify-content: space-between; align-items: center; border-bottom: 1px solid var(--background); padding-bottom: 0.75rem;">
                <div class="flex" style="align-items: center; gap: 0.75rem;">
                    {% with author=post.author %}
                    <span style="font-weight: 700;">{{ author.display_name }}</span>
                    {% endwith %}
                    {% if post.author.is_teacher %}
                    <span class="badge badge-primary">{% trans "Teacher" %}</span>
                    {% endif %}
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                    <small class="text-muted">{{ post.created_at|date:"M j, Y - g:i A" }}</small>
                    {% if user.is_authenticated and user != post.author %}
                    <button onclick="openReportModal('{{ post.id }}', '{% get_content_type_id post %}')"
                        style="background:none; border:none; padding:0; cursor:pointer; color: var(--text-muted); margin-top: 0.25rem; display: flex; align-items: center; justify-content: center;"
                        title="{% trans 'Report' %}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                            <line x1="4" x2="4" y1="22" y2="15"></line>
                        </svg>
                    </button>
                    {% endif %}
                </div>
            </div>
            <div style="line-height: 1.7; color: var(--text);">
                {{ post.content|linebreaks }}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Reply Form -->
    <div class="card mt-5" style="border-top: 4px solid var(--primary);">
        <h3 class="mb-4">{% trans "Post a Reply" %}</h3>
        <form method="post">
            {% csrf_token %}
            <div class="form-group">
                {{ form.content }}
            </div>
            <button type="submit" class="btn btn-primary mt-3">{% trans "Submit Reply" %}</button>
        </form>
    </div>
</div>
{% include 'moderation/report_modal.html' %}
{% endblock %}