{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<div class="container-narrow">
    <div class="card">
        <h1 class="mb-4">{% trans "Upload New Resource" %}</h1>

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {% for field in form %}
            <div class="form-group mb-4">
                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}
                <small class="text-muted d-block mt-1">{{ field.help_text }}</small>
                {% endif %}
                {% if field.errors %}
                <div class="alert alert-error mt-2">
                    {{ field.errors.0 }}
                </div>
                {% endif %}
            </div>
            {% endfor %}

            <div class="flex" style="gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="btn btn-primary">
                    {% if user.is_teacher or user.is_staff %}{% trans "Publish Resource" %}{% else %}{% trans "Submit for Approval" %}{% endif %}
                </button>
                <a href="{% url 'resource_list' %}" class="btn btn-secondary">{% trans "Cancel" %}</a>
            </div>
        </form>
    </div>
</div>
{{ subject_choices|json_script:"subject-choices-data" }}
{{ stream_choices|json_script:"stream-choices-data" }}

<script>
    const streamChoices = JSON.parse(document.getElementById('stream-choices-data').textContent).reduce((acc, [val, label]) => {
        acc[val] = label;
        return acc;
    }, {});

    const streamToSubjects = {
        'common_science': ['math', 'science', 'physics', 'arabic', 'english', 'french', 'hist_geo'],
        'common_literature': ['math', 'science', 'physics', 'arabic', 'english', 'french', 'hist_geo'],
        'math': ['math', 'science', 'physics', 'arabic', 'english', 'french', 'hist_geo'],
        'science': ['math', 'science', 'physics', 'arabic', 'english', 'french', 'hist_geo'],
        'languages': ['math', 'science', 'physics', 'arabic', 'english', 'french', 'hist_geo', 'german', 'spanish', 'philosophy'],
        'literature': ['math', 'science', 'physics', 'arabic', 'english', 'french', 'hist_geo', 'philosophy'],
        'management_economics': ['math', 'physics', 'arabic', 'english', 'french', 'hist_geo', 'accounting', 'law', 'economy'],
        'civil_engineering': ['math', 'physics', 'arabic', 'english', 'french', 'hist_geo', 'civil_eng']
    };

    const subjectChoices = JSON.parse(document.getElementById('subject-choices-data').textContent).reduce((acc, [val, label]) => {
        acc[val] = label;
        return acc;
    }, {});

    const yearSelect = document.getElementById('id_year');
    const streamSelect = document.getElementById('id_stream');
    const subjectSelect = document.getElementById('id_subject');

    function updateStreams() {
        const year = yearSelect.value;
        const currentStream = streamSelect.value;

        streamSelect.innerHTML = '<option value="">---------</option>';

        let validStreams = [];
        if (year == '1') {
            validStreams = ['common_science', 'common_literature'];
        } else if (year == '2' || year == '3') {
            validStreams = ['math', 'science', 'languages', 'literature', 'management_economics', 'civil_engineering'];
        } else {
            validStreams = Object.keys(streamChoices);
        }

        validStreams.forEach(s => {
            const option = document.createElement('option');
            option.value = s;
            option.textContent = streamChoices[s];
            if (s === currentStream) option.selected = true;
            streamSelect.appendChild(option);
        });

        updateSubjects();
    }

    function updateSubjects() {
        const year = yearSelect.value;
        const stream = streamSelect.value;
        const currentSubject = subjectSelect.value;

        let validSubjects = stream ? [...streamToSubjects[stream]] : Object.keys(subjectChoices);

        if (year == '2') {
            if (stream !== 'languages' && stream !== 'literature') {
                validSubjects = validSubjects.filter(s => s !== 'philosophy');
            }
        } else if (year == '1') {
            validSubjects = validSubjects.filter(s => s !== 'philosophy');
        } else if (year == '3') {
            if (!validSubjects.includes('philosophy')) {
                validSubjects.push('philosophy');
            }
        }

        subjectSelect.innerHTML = '<option value="">---------</option>';

        validSubjects.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub;
            option.textContent = subjectChoices[sub];
            if (sub === currentSubject) option.selected = true;
            subjectSelect.appendChild(option);
        });
    }

    if (yearSelect) {
        yearSelect.addEventListener('change', updateStreams);
        streamSelect.addEventListener('change', updateSubjects);
        updateStreams();
    }

    document.querySelectorAll('input:not([type="checkbox"]), textarea, select').forEach(input => {
        if (!input.classList.contains('form-input')) {
            input.classList.add('form-input');
        }
    });
</script>
{% endblock %}